import os
import sys
import itertools
from bs4 import BeautifulSoup

script = ''' 
        hacked = function() {
            alert('hacked');
        }
        window.addEventListener('load', 
          function() { 
            var f = document.querySelector("form");
            f.setAttribute("onsubmit", "hacked()");
          },
          false
        );
        '''

def func(file_name):
    with open(file_name, 'r') as file:
        soup = BeautifulSoup(file, 'html.parser')
    soup.title.string.replace_with("Evil Corp - Stealing your money every day")
    h1_tag = soup.new_tag('h1')
    username = soup.find('span', class_='name').text
    h1_tag.string = username + ', you are hacked!'
    soup.body.insert(1, h1_tag)
    script_tag = soup.new_tag('script')
    script_tag.string = script
    soup.body.append(script_tag)
    hack_link = soup.find('a')
    hack_link['href'] = 'https://mrrobot.fandom.com/wiki/Fsociety'
    hack_link.string.replace_with('Fsociety')
    with open('/'.join(file_name.split('/')[:-1] + ["evilcorp_hacked.html"]), "w") as new_file:
        new_file.write(str(soup))

    # with open(file_name, 'r') as file:
    #     lines = file.readlines()
    # lines = list(map(lambda title: '<title>'.join(title.split('<title>')[:-1]
    #         + ['Evil Corp - Money Transfer</title>'])
    #         if '<title>' in title else title, lines))
    # name = next(itertools.dropwhile(lambda line: 'Mr.' not in line, lines))
    # name = name.replace("</span>", "").replace('</p>\n', "").split('>')[-1]
    # h1 = '<h1>' + name + ", you are hacked!</h1>"
    # link = next(itertools.dropwhile(lambda line: '<a href=' not in line[1], enumerate(lines)))
    # lines[link[0]] = ''.join([link[1].split('<a href=')[0], '<a href="https://mrrobot.fandom.com/wiki/Fsociety">Fsociety</a>' + link[1].split('<a href=')[1].split('</a>')[1]])
    # lines = lines[:next(itertools.dropwhile(lambda line: '</body>' not in line[1], enumerate(lines)))[0]] + [h1, script] + \
    #     lines[next(itertools.dropwhile(lambda line: '</body>' not in line[1], enumerate(lines)))[0]:]
    # with open('/'.join(file_name.split('/')[:-1] + ["evilcorp_hacked.html"]), 'w') as new_file:
    #     new_file.writelines(lines)

if __name__ == '__main__':
    path = '/'.join(sys.argv[0].split('/')[:-2] + ['materials', 'evilcorp.html'])
    func(path)